<!DOCTYPE html>
<html>
<title>Web Bluetooth example with multiple filters</title>
<style>

.droptext {
    background-color: #f9f9f9;
    min-width: 153px;
    border: 1px solid black;
}

.dropdown {
    position: relative;
    display: inline-block;
}

.dropdown_content {
    margin-top: 25px;
    display: none;
    position: absolute;
    background-color: #f9f9f9;
    min-width: 160px;
    font-size: xx-small;
}

.dropdown_content p {
    color: black;
    padding: 6px;
    display: block;
    cursor: pointer;
}

.dropdown_content p:hover {background-color: #969696}

.dropdown:hover .dropdown_content {
    display: block;
}

.servicebtn {
    margin-left: 12px;
    background-color: #00ff00;
    display: block;
    max-width: 220px;
    text-align: left;
}

.servicebtn:hover {
    background-color: #ff0000;
}

.services_div {
    max-width: 300px;
    padding-top: 30px;
}

#right {
    position: fixed;
    left: 320px;
    top: 0px;
}

#right_content {
    margin-top: 42px;
}

#log {
    position: fixed;
    right: 0px;
    bottom: 0px;
}
</style>
<body>
    <div id="content">
        <div id="filters">
            <div>
                <p>Filter 1</p>
                <div><input id="name_1" type="text" placeholder="Device Name"></div>
                <div><input id="namePrefix_1" type="text" placeholder="Device Name Prefix"></div>
                <div class="dropdown">
                    <input class="droptext" type="text" id="service_1" placeholder="Bluetooth Services ▼">
                    <div class="dropdown_content">
                        <p onclick="addService('battery_service',1)">battery_service</p>
                        <p onclick="addService('blood_pressure',1)">blood_pressure</p>
                        <p onclick="addService('body_composition',1)">body_composition</p>
                        <p onclick="addService('bond_management',1)">bond_management</p>
                        <p onclick="addService('continuous_glucose_monitoring',1)">continuous_glucose_monitoring</p>
                        <p onclick="addService('current_time',1)">current_time</p>
                        <p onclick="addService('cycling_power',1)">cycling_power</p>
                        <p onclick="addService('cycling_speed_and_cadence',1)">cycling_speed_and_cadence</p>
                        <p onclick="addService('device_information',1)">device_information</p>
                        <p onclick="addService('environmental_sensing',1)">environmental_sensing</p>
                        <p onclick="addService('glucose',1)">glucose</p>
                        <p onclick="addService('health_thermometer',1)">health_thermometer</p>
                        <p onclick="addService('heart_rate',1)">heart_rate</p>
                    </div>
                    <button onclick="addNewServiceBtn(1)">Add Service</button>
                </div>
                <div id="services_1" class="services_div"></div>
            </div>
        </div>
        <div id="buttons">
            <button type="button" onclick="addNewFilter()">Add New Filter</button>
        </div>
        <button type="button" onclick="findDevice()">Find device</button>
        <pre id="log"></pre>
        <div id="right">
            <div class="dropdown">
                <p>Optional Services</p>
                <input class="droptext" type="text" id="optionalService" placeholder="Bluetooth Services ▼">
                <div class="dropdown_content" id="right_content">
                    <p onclick="addOptionalService('battery_service')">battery_service</p>
                    <p onclick="addOptionalService('blood_pressure')">blood_pressure</p>
                    <p onclick="addOptionalService('body_composition')">body_composition</p>
                    <p onclick="addOptionalService('bond_management')">bond_management</p>
                    <p onclick="addOptionalService('continuous_glucose_monitoring')">continuous_glucose_monitoring</p>
                    <p onclick="addOptionalService('current_time')">current_time</p>
                    <p onclick="addOptionalService('cycling_power')">cycling_power</p>
                    <p onclick="addOptionalService('cycling_speed_and_cadence')">cycling_speed_and_cadence</p>
                    <p onclick="addOptionalService('device_information')">device_information</p>
                    <p onclick="addOptionalService('environmental_sensing')">environmental_sensing</p>
                    <p onclick="addOptionalService('glucose')">glucose</p>
                    <p onclick="addOptionalService('health_thermometer')">health_thermometer</p>
                    <p onclick="addOptionalService('heart_rate')">heart_rate</p>
                </div>
            </div>
            <div><button onclick="addNewOptionalServiceBtn()">Add Optional Service Service</button></div>
            <div id="optionalServices" class="services_div"></div>
        </div>
    <div>
    <script>
    var filterCount = 1;
    var device;
    var server;
    var primaryService;
    var characteristic;
    function addNewServiceBtn(filterNumber) {
        var serviceName = document.getElementById('service_' + filterNumber).value;
        if(serviceName)
            return addService(serviceName, filterNumber);
    }

    function addService(serviceName, filterNumber) {
        if(!(document.getElementById(serviceName + "_" + filterNumber))) {
            var button = document.createElement('button');
            button.setAttribute('id', serviceName + "_" + filterNumber);
            button.setAttribute('class', 'servicebtn')
            button.setAttribute('onclick', 'removeButton(this)');
            button.innerHTML = "  ⓧ  " + serviceName;
            document.getElementById('services_' + filterNumber).appendChild(button);
        }
    }

    function addNewOptionalServiceBtn() {
        var serviceName = document.getElementById('optionalService').value;
        if(serviceName)
            return addOptionalService(serviceName);
    }

    function addOptionalService(serviceName) {
        if(!(document.getElementById(serviceName))) {
            var button = document.createElement('button');
            button.setAttribute('id', serviceName);
            button.setAttribute('class', 'servicebtn')
            button.setAttribute('onclick', 'removeButton(this)');
            button.innerHTML = "  ⓧ  " + serviceName;
            document.getElementById('optionalServices').appendChild(button);
        }
    }

    function removeButton(button) {
        button.remove();
    }

    function addNewFilter() {
        clear();
        var prevServices = document.getElementById('services_' + filterCount).childElementCount;
        var prevName = document.getElementById('name_'+ filterCount).value;
        var prevNamePrefix = document.getElementById('namePrefix_' + filterCount).value;
        if (!(prevServices || prevName || prevNamePrefix)) {
            clear();
            return log('Cannot create next filter, if the previous filter is empty');
        }
        filterCount++;

        var newDiv = document.createElement('div');
        var newP = document.createElement('p');
        var filterText = document.createTextNode('Filter '+ filterCount);
        newP.appendChild(filterText);
        newDiv.appendChild(newP);

        var newDropdownDiv = document.createElement('div');
        newDropdownDiv.setAttribute('class', 'dropdown');

        var newInputField = document.createElement('input');
        newInputField.setAttribute('class','droptext');
        newInputField.setAttribute('type','text');
        newInputField.setAttribute('id', 'service' + filterCount);
        newInputField.setAttribute('placeholder','Bluetooth Services ▼');
        newDropdownDiv.appendChild(newInputField);

        var newDropdownContentDiv = document.createElement('div');
        newDropdownContentDiv.setAttribute('class', 'dropdown_content');
        newDropdownContentDiv.innerHTML = "<p onclick=\"addService('battery_service'," + filterCount + ")\">battery_service</p><p onclick=\"addService('blood_pressure'," + filterCount + ")\">blood_pressure</p><p onclick=\"addService('body_composition'," + filterCount + ")\">body_composition</p><p onclick=\"addService('bond_management'," + filterCount + ")\">bond_management</p><p onclick=\"addService('continuous_glucose_monitoring'," + filterCount + ")\">continuous_glucose_monitoring</p><p onclick=\"addService('current_time'," + filterCount + ")\">current_time</p><p onclick=\"addService('cycling_power'," + filterCount + ")\">cycling_power</p><p onclick=\"addService('cycling_speed_and_cadence'," + filterCount + ")\">cycling_speed_and_cadence</p><p onclick=\"addService('device_information'," + filterCount + ")\">device_information</p><p onclick=\"addService('environmental_sensing'," + filterCount + ")\">environmental_sensing</p><p onclick=\"addService('glucose'," + filterCount + ")\">glucose</p><p onclick=\"addService('health_thermometer'," + filterCount + ")\">health_thermometer</p><p onclick=\"addService('heart_rate'," + filterCount + ")\">heart_rate</p>";
        newDropdownDiv.appendChild(newDropdownContentDiv);

        var newAddServiceBtn = document.createElement('button');
        newAddServiceBtn.setAttribute('onclick', 'addNewServiceBtn(' + filterCount + ')');
        newAddServiceBtn.innerHTML = "Add Service";
        newDropdownDiv.appendChild(newAddServiceBtn);

        newInputField = document.createElement('input');
        newInputField.setAttribute('id','name_'+ filterCount);
        newInputField.setAttribute('placeholder','Device Name');
        var div = document.createElement('div');
        div.appendChild(newInputField);
        newDiv.appendChild(div);

        newInputField = document.createElement('input');
        newInputField.setAttribute('id','namePrefix_'+ filterCount);
        newInputField.setAttribute('placeholder','Device Name Prefix');
        div = document.createElement('div');
        div.appendChild(newInputField);
        newDiv.appendChild(div);

        newDiv.appendChild(newDropdownDiv);

        var newServicesDiv = document.createElement('div');
        newServicesDiv.setAttribute('id', 'services_' + filterCount);
        newServicesDiv.setAttribute('class', 'services_div');
        newDiv.appendChild(newServicesDiv);

        document.getElementById('filters').appendChild(newDiv);

        if(!document.getElementById('deleteButton')) {
            var deleteButton = document.createElement('button');
            deleteButton.setAttribute('id', 'deleteButton');
            deleteButton.setAttribute('onclick','removeLastfilter()');
            document.getElementById('buttons').appendChild(deleteButton);
            document.getElementById('deleteButton').innerHTML = 'Remove Last Filter';
        }
    }

    function removeLastfilter() {
        var filtersDiv = document.getElementById('filters');
        filtersDiv.removeChild(filtersDiv.lastChild);
        if (--filterCount === 1) {
            var buttonsDiv = document.getElementById('buttons');
            buttonsDiv.removeChild(buttonsDiv.lastChild);
        }
    }

    function findDevice() {
        var options = {filters: [{}], optionalServices: []};
        clear();
        for (var i = 1; i <= filterCount; ++i) {
            if(!options.filters[i-1]) {
                options.filters[i-1] = {};
            }
            var serviceBtn = document.getElementById('services_' + i).firstChild;
            if (serviceBtn) {
                options.filters[i-1].services = [];
            }
            while (serviceBtn) {
                var serviceName = serviceBtn.id.split('_' +  i)[0];
                if(serviceName.startsWith('0x'))
                    serviceName = parseInt(serviceName, 16);
                options.filters[i-1].services.push(serviceName);
                serviceBtn = serviceBtn.nextSibling;
            }

            var filterName = document.getElementById('name_' + i).value;
            if (filterName)
                options.filters[i-1].name = filterName;

            var filterNamePrefix = document.getElementById('namePrefix_' + i).value;
            if (filterNamePrefix)
                options.filters[i-1].namePrefix = filterNamePrefix;
        }

        var optServiceBtn = document.getElementById('optionalServices').firstChild;
        while (optServiceBtn) {
            var serviceName = optServiceBtn.id;
            if(serviceName.startsWith('0x'))
                serviceName = parseInt(serviceName,16);
            options.optionalServices.push(serviceName);
            optServiceBtn = optServiceBtn.nextSibling;
        }

        try {
            log('Requesting Bluetooth Device...');
            device = window.navigator.bluetooth.requestDevice(options);

            log('Connecting to GATTserver on device...');
            server = device.gatt.connect();
            document.getElementById('content').innerHTML = '<div id="params"><p id="title">Currently connected to GATT Server</p><input id="requested" type="text"><div><button type="button" onclick="getPrimaryService()">Get Primary Service</button><button type="button" onclick="getAndListPrimaryServices()">List Primary Services on Server</button></div></div><pre id="log"></pre>';
        } catch(err) {
            log(err);
        }
    }

    function getPrimaryService() {
        clear();
        var requestedService = document.getElementById('requested').value;
        try {
            if(requestedService) {
                if(requestedService.startsWith('0x'))
                    requestedService = parseInt(requestedService, 16);
                log('Getting Primary Service...');
                primaryService = server.getPrimaryService(requestedService);
                log('Primary Service found on device: ' + primaryService.device.name);
                log('> UUID:                          ' + primaryService.uuid);
                log('> Is primary:                    ' + primaryService.isPrimary);
                document.getElementById('title').innerHTML = 'Currently connected to Primary Service (' + document.getElementById('requested').value + ').';
                if (!document.getElementById('getInclServiceBtn')) {
                    var newDiv = document.createElement('div');
                    var getInclServiceBtn = document.createElement('button');
                    getInclServiceBtn.setAttribute('id','getInclServiceBtn');
                    getInclServiceBtn.setAttribute('onclick','getIncludedService()');
                    var getInclServicesBtn = document.createElement('button');
                    getInclServicesBtn.setAttribute('id','getInclServicesBtn');
                    getInclServicesBtn.setAttribute('onclick','getAndListIncludedServices()');
                    newDiv.appendChild(getInclServiceBtn);
                    newDiv.appendChild(getInclServicesBtn);
                    document.getElementById('params').appendChild(newDiv);
                    document.getElementById('getInclServiceBtn').innerHTML = 'Get Included Service';
                    document.getElementById('getInclServicesBtn').innerHTML = 'Get Included Services';
                }

                if (!document.getElementById('getCharBtn')) {
                    var newDiv = document.createElement('div');
                    var getCharBtn = document.createElement("button");
                    getCharBtn.setAttribute('id','getCharBtn');
                    getCharBtn.setAttribute('onclick','findAndReadCharacteristic()');
                    newDiv.appendChild(getCharBtn);
                    document.getElementById('params').appendChild(newDiv);
                    document.getElementById('getCharBtn').innerHTML = 'Read Characteristic';
                }
                if (!document.getElementById('writeBtn')) {
                    var newDiv = document.createElement('div');
                    var writeBtn = document.createElement("button");
                    var inputField = document.createElement('input');
                    inputField.setAttribute('type','text');
                    inputField.setAttribute('id','newValue');
                    inputField.setAttribute('placeholder','New value');
                    writeBtn.setAttribute('id','writeBtn');
                    writeBtn.setAttribute('onclick','writeCharacteristicValue()');
                    newDiv.appendChild(writeBtn);
                    newDiv.appendChild(inputField);
                    document.getElementById('params').appendChild(newDiv);
                    document.getElementById('writeBtn').innerHTML = 'Write Characteristic';
                }
                if (!document.getElementById('getCharsBtn')) {
                    var newDiv = document.createElement('div');
                    var getCharsBtn = document.createElement("button");
                    getCharsBtn.setAttribute('id','getCharsBtn');
                    getCharsBtn.setAttribute('onclick','findAndListCharacteristics()');
                    newDiv.appendChild(getCharsBtn);
                    document.getElementById('params').appendChild(newDiv);;
                    document.getElementById('getCharsBtn').innerHTML = 'List Characteristics';
                }
            } else {
                log('Text field not filled!');
            }
        } catch(err) {
            log(err);
        }
    }


    function getAndListPrimaryServices() {
        clear();
        var requestedService = document.getElementById('requested').value;
        try {
            if(requestedService) {
                if(requestedService.startsWith('0x'))
                    var requestedService = parseInt(requestedService, 16);
                log('Searching for the requested Services...');
                var primaryServices = server.getPrimaryServices(requestedService);
                log('> List of Services, with the given Service (' + document.getElementById('requested').value + ') on the current GATT Server:')
                for(i = 0; i < primaryServices.length; ++i) {
                    log('> #' + (i+1) + ": " + primaryServices[i].uuid);
                }
            } else {
                log('Searching for Services without any Service name/UUID supplied...');
                var primaryServices = server.getPrimaryServices();
                log('> List of Services on the current GATT Server:');
                for(i = 0; i < primaryServices.length; ++i) {
                    log('> #' + (i+1) + ": " + primaryServices[i].uuid);
                }
            }
        } catch(err) {
            log(err);
        }
    }

    function getIncludedService() {
        clear();
        var requestedService = document.getElementById('requested').value;
        try {
            if(requestedService) {
                if(requestedService.startsWith('0x'))
                    requestedService = parseInt(requestedService, 16);
                log('Getting Included Service...');
                var includedService = primaryService.getIncludedService(requestedService);
                log('Included Service found on device: ' + includedService.device.name);
                log('> UUID:                           ' + includedService.uuid);
                log('> Is primary:                     ' + includedService.isPrimary);
                document.getElementById('title').innerHTML = 'Currently connected to Service (' + document.getElementById('requested').value + ').';
            }
        } catch(err) {
            log(err);
        }
    }

    function getAndListIncludedServices() {
        clear();
        var requestedService = document.getElementById('requested').value;
        try {
            if(requestedService) {
                if(requestedService.startsWith('0x'))
                    var requestedService = parseInt(requestedService, 16);
                log('Searching for the requested Services...');
                var includedServices = primaryService.getIncludedServices(requestedService);
                log('> List of Included Services, with the given Service (' + document.getElementById('requested').value + ') for the current Primary Service (' + primaryService.uuid + '):')
                for(i = 0; i < includedServices.length; ++i) {
                    log('> #' + (i+1) + ": " + includedServices[i].uuid);
                }
            } else {
                log('Searching for Services...');
                var includedServices = primaryService.getIncludedServices();
                log('> List of Included Services on the current GATT Server for the current Primary Service (' + primaryService.uuid + '):');
                for(i = 0; i < includedServices.length; ++i) {
                    log('> #' + (i+1) + ": " + includedServices[i].uuid);
                }
            }
        } catch(err) {
            log(err);
        }
    }

    function findAndReadCharacteristic() {
        clear();
        var requestedCharacteristic = document.getElementById('requested').value;
        try {
            if(requestedCharacteristic) {
                if(requestedCharacteristic.startsWith('0x'))
                    requestedCharacteristic = parseInt(requestedCharacteristic, 16);
                log('Searching for the requested Characteristic...');
                characteristic = primaryService.getCharacteristic(requestedCharacteristic);
                log("Reading the Characteristic's Value...");
                var value = asciiToDecimal(characteristic.readValue());
                log("> Characteristic's value is:" + value);
            } else {
                log("Text field not filled!");
            }
        } catch(err) {
            log(err);
        }
    }

    function findAndListCharacteristics() {
        clear();
        var requestedCharacteristic = document.getElementById('requested').value;
        try {
            if(requestedCharacteristic) {
                if(requestedCharacteristic.startsWith('0x'))
                    requestedCharacteristic = parseInt(requestedCharacteristic, 16);
                log('Searching for the requested Characteristic...');
                characteristics = primaryService.getCharacteristics(requestedCharacteristic);
                log('> List of the Characteristics, with the given Characteristic (' + document.getElementById('requested').value + ') in the current Service:');
                for(i = 0; i < characteristics.length; ++i) {
                    log('> #' + (i+1) + ": " + characteristics[i].uuid);
                }
            } else {
                log('Searching for Characteristics without Characteristic name/UUID supplied...');
                var characteristics = primaryService.getCharacteristics();
                log('> List of Characteristics in the current Service:');
                for(i = 0; i < characteristics.length; ++i) {
                    log('> #' + (i+1) + ": " + characteristics[i].uuid);
                }
            }
        } catch(err) {
            log(err);
        }
    }

    function writeCharacteristicValue() {
        clear();
        var requestedCharacteristic = document.getElementById('requested').value;
        var newValue = document.getElementById('newValue').value;
        if (newValue && requestedCharacteristic) {
            try {
                log('Searching for the Characteristic...');
                characteristic = primaryService.getCharacteristic(requestedCharacteristic);
                log("Writing the Characteristic's Value...");
                characteristic.writeValue(decimalToASCII(newValue));
                log("> Characteristic's value is:" + value);
            } catch(err) {
                log(err);
            }
        }
    }

    function clear() {
        document.getElementById("log").textContent = "";
    }

    function log(line) {
        document.getElementById("log").textContent += line + '\n';
    }

    function asciiToDecimal(byteStr) {
        var result = [];
        for(i = 0; i < byteStr.length; i++) {
            result[i] = byteStr[i].charCodeAt(0);
        }
        return result;
    }

    function decimalToASCII(inputStr) {
        var splitString = inputStr.split("");
        var result = [];
        for(i = 0; i < splitString.length; i++) {
            result[i] = String.fromCharCode(splitString[i]);
        }
        return result;
    }
    </script>
</body>
</html>
